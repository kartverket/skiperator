apiVersion: kuttl.dev/v1beta1
kind: TestSuite
startControlPlane: true
commands:
- command: kubectl create namespace istio-system
- command: kubectl apply --filename https://raw.githubusercontent.com/istio/istio/1.15.1/manifests/charts/base/crds/crd-all.gen.yaml
- command: kubectl apply --filename https://github.com/cert-manager/cert-manager/releases/download/v1.9.1/cert-manager.yaml
- command: kubectl delete validatingwebhookconfiguration cert-manager-webhook
- command: kubectl delete mutatingwebhookconfiguration cert-manager-webhook

- command: kubectl apply --filename deployment
- command: kubectl create namespace skiperator-system
- command: kubectl create configmap gcpidentityconfig --from-literal="workloadIdentityPool=testPool" --from-literal="identityProvider=testProvider" -n skiperator-system
- command: kubectl create namespace test

- command: kubectl create serviceaccount --namespace test skiperator
- command: kubectl create clusterrolebinding skiperator --clusterrole skiperator --serviceaccount test:skiperator
- script: kubectl config set-credentials skiperator --token "$(kubectl create token --namespace test skiperator)"
- command: kubectl config set-context skiperator --cluster cluster --user skiperator
- command: kubectl config use-context skiperator

- command: skiperator -l -ln test
  background: true
parallel: 1
namespace: test
testDirs:
- tests